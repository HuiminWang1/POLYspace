<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Multi-sample analysis of human melanoma data • POLYspace</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Multi-sample analysis of human melanoma data">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">POLYspace</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html">Home</a></li>
<li class="nav-item"><a class="nav-link" href="../about.html">About</a></li>
<li class="nav-item"><a class="nav-link" href="../installation.html">Installation</a></li>
<li class="nav-item"><a class="nav-link" href="../experiments.html">Experiments</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/HuiminWang1/POLYspace/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Multi-sample analysis of human melanoma data</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/HuiminWang1/POLYspace/blob/HEAD/vignettes/multi_sample_human_melanoma.Rmd" class="external-link"><code>vignettes/multi_sample_human_melanoma.Rmd</code></a></small>
      <div class="d-none name"><code>multi_sample_human_melanoma.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This tutorial provides an example using POLYspace on human melanoma
data from Hoch et al., 2022 to analyze and compare multiple spatial
sequencing samples.</p>
<p>Before running this tutorial, please make sure that the POLYspace
package is installed.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/HuiminWang1/POLYspace" class="external-link">POLYspace</a></span><span class="op">)</span></span></code></pre></div>
<p>The human melanoma spatial sequencing data used in this tutorial are
included in the package and can be loaded directly using:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">dataset_melanoma</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dataset_melanoma</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "samples"    "sample_id"  "group"      "subject_id" "des"       </span></span>
<span><span class="co">#&gt; [6] "coef"</span></span></code></pre></div>
<p>The storage contains the following elements:</p>
<ul>
<li><p><code>samples</code>: A list containing the required input for
each sample, including cellular features and spatial coordinates, which
serves as the primary input for downstream analyses.</p></li>
<li><p><code>sample_id</code>: A unique identifier for each spatial
sample, used to distinguish different slides in multi-sample
analyses.</p></li>
<li><p><code>group</code>: Sample-level grouping information indicating
immune infiltration status, used for comparative analyses across
conditions.</p></li>
<li><p><code>subject_id</code>: The identifier of the patient from whom
each sample was obtained, allowing multiple samples from the same
individual to be linked.</p></li>
<li><p><code>des</code>: The experimental design matrix specifying the
relationships among samples, groups, and subjects for regression
analyses comparing cellular neighborhoods across multiple
slides.</p></li>
<li><p><code>coef</code>: The name(s) of the model coefficient(s)
defining the contrast(s) of interest in the multi-sample regression
analyses.</p></li>
</ul>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">samples</span> <span class="op">=</span> <span class="va">dataset_cortex</span><span class="op">$</span><span class="va">samples</span></span>
<span><span class="va">sample_id</span> <span class="op">=</span> <span class="va">dataset_cortex</span><span class="op">$</span><span class="va">sample_id</span></span></code></pre></div>
<div class="section level4">
<h4 id="create-a-polyspace-object">Create a POLYspace object<a class="anchor" aria-label="anchor" href="#create-a-polyspace-object"></a>
</h4>
<p>Because this dataset contains a large number of samples, we recommend
not combining all samples into a single POLYspace object. Instead, we
suggest constructing one POLYspace object per sample, which allows
enrichment analyses to be parallelized across samples. This strategy
enables more efficient use of computational resources and substantially
improves overall analysis performance. Below we illustrate the analysis
pipeline for a single sample, from input construction through enrichment
analysis, following the same workflow used for the mouse cortex
example.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Retrieve the task ID from the SLURM array environment variable</span></span>
<span><span class="va">taskID</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"SLURM_ARRAY_TASK_ID"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a POLYspace object for a single sample specified by the task ID</span></span>
<span><span class="va">obj</span> <span class="op">=</span> <span class="fu"><a href="../reference/createPOLYspaceObject.html">createPOLYspaceObject</a></span><span class="op">(</span></span>
<span>  samples <span class="op">=</span> <span class="va">samples</span><span class="op">[</span><span class="va">taskID</span><span class="op">]</span>,</span>
<span>  id_of_samples <span class="op">=</span> <span class="va">sample_id</span><span class="op">[</span><span class="va">taskID</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Construct the spatial cell–cell neighboring network</span></span>
<span><span class="va">obj</span> <span class="op">=</span> <span class="fu"><a href="../reference/constructSpatialNetwork.html">constructSpatialNetwork</a></span><span class="op">(</span>POLYspace <span class="op">=</span> <span class="va">obj</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Identify spatial neighborhoods based on the constructed network</span></span>
<span><span class="va">obj</span> <span class="op">=</span> <span class="fu"><a href="../reference/neighborhoodMining.html">neighborhoodMining</a></span><span class="op">(</span>POLYspace <span class="op">=</span> <span class="va">obj</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Annotate the neighborhoods</span></span>
<span><span class="va">obj</span> <span class="op">=</span> <span class="fu"><a href="../reference/neighborhoodAnnotation.html">neighborhoodAnnotation</a></span><span class="op">(</span>POLYspace <span class="op">=</span> <span class="va">obj</span><span class="op">)</span></span></code></pre></div>
<p>After neighborhood annotation, we construct a consistent set of
neighborhoods of interest across samples by taking the union of
neighborhoods for each target.<br>
This ensures that the same set of neighborhoods is considered for all
samples.<br>
The union is obtained using the following code, where is a list of all
annotated objects.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">targets</span> <span class="op">=</span> <span class="va">files</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">@</span><span class="va">targets</span></span>
<span></span>
<span><span class="va">neighborhoods_of_interest</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">targets</span>, <span class="kw">function</span><span class="op">(</span><span class="va">to</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">files</span>,<span class="kw">function</span><span class="op">(</span><span class="va">ob</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">ob</span><span class="op">@</span><span class="va">annotations</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/match.html" class="external-link">match</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">to</span><span class="op">)</span>,<span class="va">ob</span><span class="op">@</span><span class="va">targets</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="va">neighborhoods_of_interest</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">neighborhoods_of_interest</span>,<span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">neighborhoods_of_interest</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">neighborhoods_of_interest</span>,<span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"other"</span>, <span class="va">x</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">targets</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">targets</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,<span class="st">'singlet'</span><span class="op">)</span><span class="op">|</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">targets</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,<span class="st">'pair'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">vec</span> <span class="op">=</span> <span class="va">neighborhoods_of_interest</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">vec</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">jd_frame</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">vec</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">y</span> <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_split.html" class="external-link">str_split</a></span><span class="op">(</span><span class="va">x</span>,<span class="st">'--'</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_split.html" class="external-link">str_split</a></span><span class="op">(</span><span class="va">y</span>,<span class="st">'_'</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">z</span><span class="op">)</span> <span class="va">z</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="op">}</span><span class="op">)</span></span>
<span>    </span>
<span>    </span>
<span>      <span class="va">jd</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">jd_frame</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>        </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>        </span>
<span>      <span class="op">}</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="va">neighborhoods_of_interest</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="va">vec</span><span class="op">[</span><span class="va">jd</span><span class="op">]</span></span>
<span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Perform neighborhood enrichment analysis using permutation testing</span></span>
<span><span class="va">obj</span> <span class="op">=</span> <span class="fu"><a href="../reference/neighborhoodEnrichment.html">neighborhoodEnrichment</a></span><span class="op">(</span>POLYspace <span class="op">=</span> <span class="va">obj</span>,</span>
<span>                             neighborhoods_of_interest <span class="op">=</span> <span class="va">neighborhoods_of_interest</span>,</span>
<span>                             permutation_times <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>                             ncores <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span></code></pre></div>
<p>After enrichment analysis has been completed for all samples, the
resulting objects are collected into a list, denoted here as .<br>
This list is then used as input to identify differential neighborhoods
associated with immune infiltration status, while controlling for
subject information.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extract the design matrix for comparing immune-hot versus immune-cold samples</span></span>
<span><span class="va">des</span> <span class="op">=</span> <span class="va">dataset_melanoma</span><span class="op">[[</span><span class="st">"des"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"hot_vs_cold"</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Extract the coefficient specifying the contrast of interest (hot vs. cold)</span></span>
<span><span class="va">coef</span> <span class="op">=</span> <span class="va">dataset_melanoma</span><span class="op">[[</span><span class="st">"coef"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"hot_vs_cold"</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Perform joint enrichment analysis to identify differential neighborhoods</span></span>
<span><span class="co"># associated with immune infiltration status while controlling for subject effects</span></span>
<span><span class="va">res</span> <span class="op">=</span> <span class="fu"><a href="../reference/polyEnrichment.html">polyEnrichment</a></span><span class="op">(</span></span>
<span>  object <span class="op">=</span> <span class="va">files</span>,</span>
<span>  neighborhoods_of_interest <span class="op">=</span> <span class="st">"union"</span>,</span>
<span>  des <span class="op">=</span> <span class="va">des</span>,</span>
<span>  coef <span class="op">=</span> <span class="va">coef</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The parameter <code>neighborhoods_of_interest</code> specifies which
set of neighborhoods is included in the joint analysis across samples.
Because each sample may contain a different set of neighborhood
topologies, this parameter controls how neighborhoods are aligned across
samples.</p>
<ul>
<li><p><code>"union"</code>: Uses the union of all neighborhood types
observed across samples. This option includes any neighborhood that
appears in at least one sample and is useful when neighborhood
composition varies substantially across samples.</p></li>
<li><p><code>"intersect"</code>: Uses only the neighborhoods that are
shared by all samples. This option restricts the analysis to common
neighborhood types and may be preferable when focusing on highly
consistent spatial patterns.</p></li>
</ul>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Huimin Wang.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
